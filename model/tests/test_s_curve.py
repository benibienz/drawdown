"""Tests for s_curve.py."""

from model import s_curve
import numpy as np
import pandas as pd
import pytest


def test_sigmoid_logistic():
    """Test logistic sigmoid, simple case."""
    sc = s_curve.SCurve(transition_period=None, sconfig=None)
    # values from Building Automation System "S Curve Adoption"!AH17:AH22
    result = sc._sigmoid_logistic(base_year=2014, last_year=2050,
            base_percent=0.346959145052, last_percent=0.95,
            base_adoption=16577.8259167003, pds_tam_2050=77969.4257883872)
    expected = pd.DataFrame(world_sigmoid_logistic_list[1:],
            columns=world_sigmoid_logistic_list[0]).set_index('Year')
    pd.testing.assert_frame_equal(result, expected, check_exact=False)

def test_sigmoid_logistic_100_percent_final_adoption():
    """Test logistic sigmoid, with 100% last_percent adoption."""
    sc = s_curve.SCurve(transition_period=None, sconfig=None)
    # values from Building Automation System "S Curve Adoption"!AJ17:AJ22
    result = sc._sigmoid_logistic(base_year=2014, last_year=2050,
            base_percent=0.677494504097, last_percent=1.0,
            base_adoption=14915.990000000000, pds_tam_2050=30578.7612542884)
    expected = pd.DataFrame(OECD90_sigmoid_logistic_list[1:],
            columns=OECD90_sigmoid_logistic_list[0]).set_index('Year')
    pd.testing.assert_frame_equal(result, expected, check_exact=False)

def test_logistic_adoption():
    # From Building Automation System "S Curve Adoption"!AJ17:AJ22
    sconfig = pd.DataFrame([
        ['World', 2014, 2050, 0.346959145052, 0.95, 16577.8259167003, 77969.4257883872],
        ['OECD90', 2014, 2050, 0.677494504097,  1.0, 14915.99, 30578.7612542884],
        ['Eastern Europe', 2014, 2050, 0.0, 0.212709603444, 325.933926458798, 1532.2953039347],
        ['Asia (Sans Japan)', 2014, 2050, 0.074153999059, 0.447707349074, 1087.77094452167 , 25358.3339750411],
        ['Middle East and Africa', 2014, 2050, 0.0, 0.085083841378, 0.0, 4140.6610709308],
        ['Latin America', 2014, 2050, 0.0, 0.223853674537, 0.0, 1021.9329224435],
        ['China', 2014, 2050, 0.0848, 0.0, 1087.77094452167, 18965.135056084],
        ['India', 2014, 2050, 0.0, 0.0, 0.0, 8804.235498036],
        ['EU', 2014, 2050, 0.482603137947, 1.0, 3622.85, 11003.3574757203],
        ['USA', 2014, 2050, 0.445634302889, 1.0, 11293.14, 36879.9583966390]],
        columns = ['region', 'base_year', 'last_year', 'base_percent', 'last_percent',
            'base_adoption', 'pds_tam_2050']).set_index('region')
    sc = s_curve.SCurve(transition_period=16, sconfig=sconfig)
    result = sc.logistic_adoption()
    expected = pd.DataFrame(logistic_s_curve_adoption_list[1:],
            columns=logistic_s_curve_adoption_list[0]).set_index('Year')
    expected.name = 'logistic_adoption'
    pd.testing.assert_frame_equal(result, expected, check_exact=False)


# Building Automation System "S Curve"!AH24:AI70
world_sigmoid_logistic_list = [
        ["Year", "first_half", "second_half"],
        [2014, 16577.825917, 35116.538355], [2015, 17354.241330, 36279.528816],
        [2016, 18196.959474, 37472.977969], [2017, 19108.111120, 38691.996375],
        [2018, 20089.231761, 39931.226537], [2019, 21141.208736, 41184.930237],
        [2020, 22264.245394, 42447.090802], [2021, 23457.844491, 43711.526609],
        [2022, 24720.812013, 44972.011376], [2023, 26051.281506, 46222.396297],
        [2024, 27446.757872, 47456.728978], [2025, 28904.178534, 48669.364323],
        [2026, 30419.988970, 49855.063101], [2027, 31990.228988, 51009.074752],
        [2028, 33610.625725, 52127.202019], [2029, 35276.689309, 53205.846083],
        [2030, 36983.807289, 54242.032029], [2031, 38727.334396, 55233.415426],
        [2032, 40502.674797, 56178.271702], [2033, 42305.354698, 57075.470578],
        [2034, 44131.083882, 57924.438278], [2035, 45975.805503, 58725.110375],
        [2036, 47835.734057, 59477.878170], [2037, 49707.381994, 60183.531279],
        [2038, 51587.575861, 60843.198857], [2039, 53473.463111, 61458.291500],
        [2040, 55362.510921, 62030.445486], [2041, 57252.498404, 62561.470591],
        [2042, 59141.503581, 63053.302366], [2043, 61027.886435, 63507.959412],
        [2044, 62910.269204, 63927.505885], [2045, 64787.514949, 64314.019269],
        [2046, 66658.705284, 64669.563228], [2047, 68523.117957, 64996.165258],
        [2048, 70380.204886, 65295.798732], [2049, 72229.571039, 65570.368924],
        [2050, 74070.954499, 65821.702523], [2051, 75904.207910, 66051.540205],
        [2052, 77729.281423, 66261.531789], [2053, 79546.207200, 66453.233587],
        [2054, 81355.085482, 66628.107550], [2055, 83156.072170, 66787.521870],
        [2056, 84949.367856, 66932.752746], [2057, 86735.208225, 67064.987036],
        [2058, 88513.855709, 67185.325589], [2059, 90285.592300, 67294.787047],
        [2060, 92050.713406, 67394.311976]]

# Building Automation System "S Curve"!AJ24:AK70
OECD90_sigmoid_logistic_list = [
        ["Year", "first_half", "second_half"],
        [2014, 14915.990000, 21597.317876], [2015, 15308.190503, 23234.255421],
        [2016, 15749.186640, 24112.576831], [2017, 16198.683572, 24507.360171],
        [2018, 16644.384724, 24670.589828], [2019, 17085.531217, 24735.734073],
        [2020, 17523.711203, 24761.364527], [2021, 17960.281174, 24771.391918],
        [2022, 18396.049770, 24775.306271], [2023, 18831.438919, 24776.832983],
        [2024, 19266.654149, 24777.428245], [2025, 19701.791472, 24777.660306],
        [2026, 20136.894487, 24777.750769], [2027, 20571.982595, 24777.786034],
        [2028, 21007.064295, 24777.799780], [2029, 21442.143263, 24777.805139],
        [2030, 21877.221075, 24777.807228], [2031, 22312.298402, 24777.808042],
        [2032, 22747.375526, 24777.808360], [2033, 23182.452565, 24777.808483],
        [2034, 23617.529569, 24777.808532], [2035, 24052.606558, 24777.808550],
        [2036, 24487.683541, 24777.808558], [2037, 24922.760522, 24777.808561],
        [2038, 25357.837502, 24777.808562], [2039, 25792.914482, 24777.808562],
        [2040, 26227.991461, 24777.808562], [2041, 26663.068441, 24777.808562],
        [2042, 27098.145420, 24777.808562], [2043, 27533.222399, 24777.808562],
        [2044, 27968.299379, 24777.808562], [2045, 28403.376358, 24777.808562],
        [2046, 28838.453337, 24777.808562], [2047, 29273.530316, 24777.808562],
        [2048, 29708.607296, 24777.808562], [2049, 30143.684275, 24777.808562],
        [2050, 30578.761254, 24777.808562], [2051, 31013.838234, 24777.808562],
        [2052, 31448.915213, 24777.808562], [2053, 31883.992192, 24777.808562],
        [2054, 32319.069171, 24777.808562], [2055, 32754.146151, 24777.808562],
        [2056, 33189.223130, 24777.808562], [2057, 33624.300109, 24777.808562],
        [2058, 34059.377089, 24777.808562], [2059, 34494.454068, 24777.808562],
        [2060, 34929.531047, 24777.808562]]

# BuildingAutomation "S Curve Adoption"!A23:K70
logistic_s_curve_adoption_list = [
        ["Year", "World", "OECD90", "Eastern Europe", "Asia (Sans Japan)", "Middle East and Africa", "Latin America", "China", "India", "EU", "USA"],
        [2014, 16577.8259167003, 14915.9900000000, np.nan, 1087.7709445217, np.nan, np.nan, np.nan, np.nan, 3622.8500000000, 11293.1400000000],
        [2015, 17354.2413299090, 15308.1905031352, np.nan, 1132.2599615581, np.nan, np.nan, np.nan, np.nan, 3781.9912229986, 11821.7401657854],
        [2016, 18196.9594737997, 15749.1866401823, np.nan, 1182.9959225503, np.nan, np.nan, np.nan, np.nan, 3990.2613374196, 12542.0144207409],
        [2017, 19108.1111195264, 16198.6835719345, np.nan, 1240.4943386935, np.nan, np.nan, np.nan, np.nan, 4211.3125498862, 13316.8694257675],
        [2018, 20089.2317607510, 16644.3847244498, np.nan, 1305.2994994260, np.nan, np.nan, np.nan, np.nan, 4428.9144483078, 14078.9498149532],
        [2019, 21141.2087356893, 17085.5312173207, np.nan, 1377.9845857676, np.nan, np.nan, np.nan, np.nan, 4641.1621893850, 14819.3109424942],
        [2020, 22264.2453936230, 17523.7112031835, np.nan, 1459.1515476811, np.nan, np.nan, np.nan, np.nan, 4849.8272691294, 15544.9840509925],
        [2021, 23457.8444911786, 17960.2811741666, np.nan, 1549.4307121413, np.nan, np.nan, np.nan, np.nan, 5056.5642316908, 16262.7510492323],
        [2022, 24720.8120133816, 18396.0497695204, np.nan, 1649.4800874940, np.nan, np.nan, np.nan, np.nan, 5262.3592871926, 16976.6668177375],
        [2023, 26051.2815057288, 18831.4389187311, np.nan, 1759.9843291132, np.nan, np.nan, np.nan, np.nan, 5467.7180414837, 17688.8054525313],
        [2024, 27446.7578715725, 19266.6541491127, np.nan, 1881.6533314747, np.nan, np.nan, np.nan, np.nan, 5672.8813480370, 18400.1512681489],
        [2025, 28904.1785335790, 19701.7914715219, np.nan, 2015.2204126715, np.nan, np.nan, np.nan, np.nan, 5877.9591047861, 19111.1515145438],
        [2026, 30419.9889700206, 20136.8944870876, np.nan, 2161.4400592613, np.nan, np.nan, np.nan, np.nan, 6083.0000506912, 19822.0036940405],
        [2027, 31990.2289875214, 20571.9825953828, np.nan, 2321.0852022828, np.nan, np.nan, np.nan, np.nan, 6288.0253657875, 20532.7932651317],
        [2028, 33610.6257248870, 21007.0642947860, np.nan, 2494.9439994444, np.nan, np.nan, np.nan, np.nan, 6493.0441135783, 21243.5566415937],
        [2029, 35276.6893094652, 21442.1432628945, np.nan, 2683.8161039876, np.nan, np.nan, np.nan, np.nan, 6698.0601259607, 21954.3091531540],
        [2030, 36983.8072891849, 21877.2210754762, np.nan, 2888.5084076379, np.nan, np.nan, np.nan, np.nan, 6903.0750072288, 22665.0571907486],
        [2031, 38727.3343958606, 22312.2984022113, np.nan, 3109.8302534502, np.nan, np.nan, np.nan, np.nan, 7108.0894236420, 23375.8033973387],
        [2032, 40502.6747972467, 22747.3755257547, np.nan, 3348.5881242124, np.nan, np.nan, np.nan, np.nan, 7313.1036500214, 24086.5488585254],
        [2033, 42305.3546976476, 23182.4525647112, np.nan, 3605.5798233690, np.nan, np.nan, np.nan, np.nan, 7518.1177990709, 24797.2940176479],
        [2034, 44131.0838816783, 23617.5295685973, np.nan, 3881.5881780223, np.nan, np.nan, np.nan, np.nan, 7723.1319167792, 25508.0390548548],
        [2035, 45975.8055034035, 24052.6065579949, np.nan, 4177.3743072916, np.nan, np.nan, np.nan, np.nan, 7928.1460218304, 26218.7840430305],
        [2036, 47835.7340570042, 24487.6835414260, np.nan, 4493.6705138685, np.nan, np.nan, np.nan, np.nan, 8133.1601217862, 26929.5290115496],
        [2037, 49707.3819940769, 24922.7605224070, np.nan, 4831.1728716513, np.nan, np.nan, np.nan, np.nan, 8338.1742196966, 27640.2739722105],
        [2038, 51587.5758605750, 25357.8375023846, np.nan, 5190.5335974275, np.nan, np.nan, np.nan, np.nan, 8543.1883167879, 28351.0189297382],
        [2039, 53473.4631105004, 25792.9144819521, np.nan, 5572.3533091821, np.nan, np.nan, np.nan, np.nan, 8748.2024135522, 29061.7638860193],
        [2040, 55362.5109214659, 26227.9914613524, np.nan, 5977.1732871604, np.nan, np.nan, np.nan, np.nan, 8953.2165101860, 29772.5088418056],
        [2041, 57252.4984040132, 26663.0684406847, np.nan, 6405.4678656845, np.nan, np.nan, np.nan, np.nan, 9158.2306067679, 30483.2537973959],
        [2042, 59141.5035809613, 27098.1454199893, np.nan, 6857.6370932691, np.nan, np.nan, np.nan, np.nan, 9363.2447033292, 31193.9987529086],
        [2043, 61182.8909962657, 27361.0090344781, np.nan, 7527.4672430466, np.nan, np.nan, np.nan, np.nan, 9552.4896642631, 31894.3299669894],
        [2044, 63037.4237889585, 27569.4880265518, np.nan, 8201.9337372665, np.nan, np.nan, np.nan, np.nan, 9716.1078631254, 32505.8180616256],
        [2045, 64698.7345092964, 27723.5823962128, np.nan, 8877.7745053186, np.nan, np.nan, np.nan, np.nan, 9854.0992999180, 33028.4630368243],
        [2046, 66161.4197697651, 27823.2921434624, np.nan, 9551.4799875799, np.nan, np.nan, np.nan, np.nan, 9966.4639746416, 33462.2648925883],
        [2047, 67420.9452388150, 27868.6172683010, np.nan, 10219.3075306154, np.nan, np.nan, np.nan, np.nan, 10053.2018872965, 33807.2236289188],
        [2048, 68473.5525785758, 27859.5577707287, np.nan, 10877.2992174127, np.nan, np.nan, np.nan, np.nan, 10114.3130378828, 34063.3392458163],
        [2049, 69316.1701134664, 27796.1136507457, np.nan, 11521.3029823285, np.nan, np.nan, np.nan, np.nan, 10149.7974264006, 34230.6117432808],
        [2050, 69946.3285109946, 27678.2849083519, np.nan, 12146.9967765711, np.nan, np.nan, np.nan, np.nan, 10159.6550528500, 34309.0411213125],
        [2051, 70362.0823256843, 27506.0715435474, np.nan, 12749.9154689451, np.nan, np.nan, np.nan, np.nan, 10143.8859172309, 34298.6273799114],
        [2052, 70561.9379013169, 27279.4735563321, np.nan, 13325.4800914573, np.nan, np.nan, np.nan, np.nan, 10102.4900195433, 34199.3705190776],
        [2053, 70544.7878410808, 26998.4909467061, np.nan, 13869.0289733050, np.nan, np.nan, np.nan, np.nan, 10035.4673597872, 34011.2705388109],
        [2054, 70309.8520330195, 26663.1237146694, np.nan, 14375.8502525616, np.nan, np.nan, np.nan, np.nan, 9942.8179379626, 33734.3274391115],
        [2055, 69856.6250513722, 26273.3718602220, np.nan, 14841.2152149053, np.nan, np.nan, np.nan, np.nan, 9824.5417540696, 33368.5412199793],
        [2056, 69184.8296346776, 25829.2353833639, np.nan, 15260.4118847675, np.nan, np.nan, np.nan, np.nan, 9680.6388081081, 32913.9118814144],
        [2057, 68294.3758607557, 25330.7142840950, np.nan, 15628.7782873874, np.nan, np.nan, np.nan, np.nan, 9511.1091000781, 32370.4394234166],
        [2058, 67185.3255893752, 24777.8085624154, np.nan, 15941.7348107286, np.nan, np.nan, np.nan, np.nan, 9315.9526299797, 31738.1238459861],
        [2059, 67294.7870471389, 24777.8085624154, np.nan, 16308.5960953450, np.nan, np.nan, np.nan, np.nan, 9315.9526299797, 31738.1238459861],
        [2060, 67394.3119759907, 24777.8085624154, np.nan, 16671.1839505851, np.nan, np.nan, np.nan, np.nan, 9315.9526299797, 31738.1238459861]]
