"""Tests for firstcost.py."""

import advanced_controls

import pandas as pd
from model import firstcost

def test_pds_install_cost_per_iunit_SolarPV_27Aug18():
  """Test PDS install cost per unit

     Values taken from SolarPVUtility_RRS_ELECGEN_v1.1d_27Aug18
  """
  ac = advanced_controls.AdvancedControls(
      pds_2014_cost=1444.93954421485,
      conv_2014_cost=2010.03170851964,
      pds_first_cost_efficiency_rate=0.196222222222222,
      pds_first_cost_below_conv=True,
      conv_first_cost_efficiency_rate=0.02)
  fc = firstcost.FirstCost(
      ac, pds_learning_increase_mult=2, conv_learning_increase_mult=2)
  pds_tot_soln_iunits_req = pd.Series([
      0.061158144891382, 0.0956963287565992, 0.147709178675075,
      0.208131559430844, 0.276585853638905, 0.352694443914253,
      0.355112754893078, 0.526364043126798, 0.623169817293988,
      0.726119417988453, 0.834835227825188, 0.866279647028161,
      1.06805500538546, 1.19180373833898, 1.31980821089477,
      1.4516908056678, 1.65078562297544, 1.72557989232562,
      1.8668311494404, 2.01045005923242, 2.15605900431668,
      2.30328036730816, 2.45173653082188, 2.60104987747283,
      2.75084278987599, 2.90073765064638, 3.07612351532151,
      3.1993227477488, 3.34725774931083, 3.49378422970006,
      3.6385245715315, 3.78110115742013, 3.92113636998096,
      4.05825259182899, 4.1920722055792, 4.3222175938466,
      4.43499993794447, 4.56997522439294, 4.68683223190188,
      4.79850454438799, 4.90461454446626, 5.00478461475171,
      5.09863713785931, 5.18579449640408, 5.265879073001,
      5.33851325026507, 5.40331941081129
      ])
  expected_pds_install_cost_per_iunit = pd.Series([
      1663888168616.12,  # added a 2014 value, the rest are from Excel
      1444939544214.85, 1260211854559.48, 1131125771261.71, 1034176540754.27,
      957914360042.17, 955853826404.52, 844363092072.89, 800615041745.80,
      762954261503.24, 730136123170.93, 721678325520.19, 675595934758.92,
      652654395751.15, 632005749879.43, 613318626692.05, 588974654797.70,
      580807336513.56, 566583683816.19, 553503708701.86, 541440613073.64,
      530286923303.66, 519950919467.44, 510353842407.28, 501427686348.92,
      493113437720.23, 484074786193.61, 478121333143.78, 471358936327.06,
      465037653845.78, 459126747449.31, 453599023283.05, 448430388622.18,
      443599480377.26, 439087352857.46, 434877214846.06, 431361401332.87,
      427305220575.04, 423918730328.15, 420784674297.91, 417894340462.60,
      415240279798.58, 412816236436.15, 410617094526.91, 408638840847.23,
      406878542591.41, 405334340227.07
      ])
  result = fc.pds_install_cost_per_iunit(pds_tot_soln_iunits_req, [])
  pd.testing.assert_series_equal(result, expected_pds_install_cost_per_iunit,
      check_exact=False, check_less_precise=12)


def test_conv_install_cost_per_iunit_SolarPV_27Aug18():
  """Test conventional install cost per unit

     Values taken from SolarPVUtility_RRS_ELECGEN_v1.1d_27Aug18
  """
  ac = advanced_controls.AdvancedControls(
      pds_2014_cost=1444.93954421485,
      conv_2014_cost=2010.03170851964,
      pds_first_cost_efficiency_rate=0.196222222222222,
      pds_first_cost_below_conv=True,
      conv_first_cost_efficiency_rate=0.02)
  fc = firstcost.FirstCost(
      ac, pds_learning_increase_mult=2, conv_learning_increase_mult=2)
  ref_tot_conv_iunits_req = pd.Series([
    4.53535289538464, 4.8796378165883, 5.05302431141252, 5.2263750432106,
    5.39969647677689, 5.57299507690575, 5.74627730839152, 5.91954963602856,
    6.09281852461121, 6.26609043893384, 6.43937184379078, 6.61266920397639,
    6.78598898428503, 6.95933764951104, 7.13272166444877, 7.30614749389258,
    7.47962160263682, 7.65315045547583, 7.82674051720397, 8.00039825261559,
    8.17413012650505, 8.34794260366669, 8.52184214889486, 8.69583522698391,
    8.8699283027282, 9.04412784092207, 9.21844030635989, 9.39287216383599,
    9.56742987814473, 9.74211991408047, 9.91694873643755, 10.0919228100103,
    10.2670485995931, 10.4423325699803, 10.6177811859663, 10.7934009123454,
    10.9691982139119, 11.1451795554602, 11.3213514017846, 11.4977202176796,
    11.6742924679394, 11.8510746173584, 12.028073130731, 12.2052944728515,
    12.3827451085142, 12.5604315025136, 12.7383601196439
    ])
  expected_conv_install_cost_per_iunit = pd.Series([
    0,
    2005749716919.21, 2003709559856.43, 2001740610594.36,
    1999838071911.36, 1997997609222.97, 1996215293069.34,
    1994487550260.54, 1992811122162.61, 1991183028908.37,
    1989600538551.80, 1988061140369.17, 1986562521656.05,
    1985102547485.31, 1983679242984.24, 1982290777764.18,
    1980935452196.45, 1979611685278.25, 1978318003872.66,
    1977053033140.28, 1975815488007.72, 1974604165541.04,
    1973417938111.52, 1972255747256.95, 1971116598155.42,
    1969999554639.64, 1968903734689.63, 1967828306349.86,
    1966772484023.75, 1965735525104.47, 1964716726906.07,
    1963715423863.49, 1962730984973.61, 1961762811452.90,
    1960810334590.08, 1959873013774.63, 1958950334684.14,
    1958041807615.42, 1957146965945.90, 1956265364713.38,
    1955396579303.22, 1954540204233.54, 1953695852029.72,
    1952863152180.40, 1952041750168.08, 1951231306567.92,
    1950431496209.24
    ])
  result = fc.conv_install_cost_per_iunit(ref_tot_conv_iunits_req)
  pd.testing.assert_series_equal(result, expected_conv_install_cost_per_iunit,
      check_exact=False, check_less_precise=12)
